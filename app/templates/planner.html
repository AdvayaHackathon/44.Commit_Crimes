{% extends "base.html" %}

{% block title %}Daily Content - Educational Content Analysis System{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Daily Content Calendar -->
    <div class="md:col-span-2 bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold mb-4">Daily Content Calendar</h2>
        <div id="content-info" class="mb-4 text-sm text-gray-600"></div>

        <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <button id="prev-month" class="text-indigo-600 hover:text-indigo-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h3 id="current-month" class="text-xl font-semibold">Loading...</h3>
                <button id="next-month" class="text-indigo-600 hover:text-indigo-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>

            <div class="grid grid-cols-7 gap-1 text-center font-semibold text-gray-600 mb-2">
                <div class="p-2">Sun</div>
                <div class="p-2">Mon</div>
                <div class="p-2">Tue</div>
                <div class="p-2">Wed</div>
                <div class="p-2">Thu</div>
                <div class="p-2">Fri</div>
                <div class="p-2">Sat</div>
            </div>

            <table class="w-full border-collapse">
                <tbody id="calendar-body">
                    <!-- Calendar will be populated here -->
                </tbody>
            </table>
        </div>

        <div id="day-details" class="mt-6 p-4 bg-gray-50 rounded-lg">
            <h3 class="text-xl font-bold mb-2">Content for <span id="selected-date">Loading...</span></h3>
            <div id="day-content-container" class="space-y-3">
                <!-- Content will be populated when a date is selected -->
            </div>
        </div>
    </div>

    <!-- Latest Content Summary -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold mb-4">Latest Content</h2>
        <div id="latest-content-container" class="space-y-4">
            <!-- Latest content will be populated here -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let dailyContent = null;
    let currentMonth = new Date();

    async function fetchDailyContent() {
        try {
            const response = await fetch('/api/daily-content');
            if (!response.ok) {
                throw new Error('Failed to fetch daily content');
            }
            const result = await response.json();
            if (result.status === 'success') {
                dailyContent = result.data;
                updateCalendar();
                showLatestContent();
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('Error fetching daily content:', error);
            document.getElementById('error-message').textContent = 'Error loading daily content. Please try again later.';
        }
    }

    function showLatestContent() {
        if (!dailyContent || !dailyContent.daily_plans) return;
        
        const container = document.getElementById('day-content-container');
        let contentHtml = `
            <div class="bg-white p-4 rounded-lg shadow mb-4">
                <h3 class="text-lg font-semibold mb-2">Exam Information</h3>
                <div class="grid grid-cols-2 gap-2">
                    <div><span class="font-medium">Exam Type:</span> ${dailyContent.exam_type}</div>
                    <div><span class="font-medium">Exam Date:</span> ${dailyContent.exam_date}</div>
                    <div><span class="font-medium">Days Until Exam:</span> ${dailyContent.days_until_exam}</div>
                </div>
            </div>
        `;

        // Get the first day's content
        const firstDay = Object.entries(dailyContent.daily_plans)[0];
        if (firstDay) {
            const [day, plan] = firstDay;
            try {
                const planContent = JSON.parse(plan.content.split('```json\n')[1].split('\n```')[0]);
                contentHtml += `<div class="space-y-4">`;
                
                Object.entries(planContent).forEach(([planDay, dayData]) => {
                    contentHtml += `
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h4 class="font-semibold text-lg mb-3">${planDay}</h4>
                            
                            <div class="mb-4">
                                <div class="font-medium text-sm text-gray-700 mb-2">Topics:</div>
                                <div class="flex flex-wrap gap-2">
                                    ${dayData.topics.map(topic => 
                                        `<span class="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full">${topic}</span>`
                                    ).join('')}
                                </div>
                        </div>

                            <div class="mb-4">
                                <div class="font-medium text-sm text-gray-700 mb-2">Time Allocation:</div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    ${Object.entries(dayData.time_allocation).map(([topic, hours]) => 
                                        `<div class="flex items-center">
                                            <div class="w-2 h-2 bg-indigo-400 rounded-full mr-2"></div>
                                            <span class="text-sm">${topic}: ${hours} hours</span>
                                        </div>`
                                    ).join('')}
                        </div>
                    </div>

                        <div>
                                <div class="font-medium text-sm text-gray-700 mb-2">Key Concepts:</div>
                                <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                                    ${dayData.key_concepts.map(concept => 
                                        `<li>${concept}</li>`
                                    ).join('')}
                                </ul>
                        </div>
                        </div>
                    `;
                });
                contentHtml += `</div>`;
            } catch (e) {
                console.error('Error parsing plan content:', e);
                contentHtml += `
                    <div class="bg-red-50 border border-red-200 text-red-700 p-4 rounded">
                        Error parsing content for ${day}
                </div>
            `;
            }
        }

        container.innerHTML = contentHtml;
    }

    function updateCalendar() {
        // Update month display
        document.getElementById('current-month').textContent = 
            currentMonth.toLocaleDateString('default', { month: 'long', year: 'numeric' });

        // Clear previous calendar
        const calendarBody = document.getElementById('calendar-body');
        calendarBody.innerHTML = '';

        // Get first day and number of days in month
        const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
        const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
        
        let currentRow = document.createElement('tr');
        currentRow.className = 'h-24';
        
        // Add empty cells for days before first of month
        for (let i = 0; i < firstDay.getDay(); i++) {
            const cell = document.createElement('td');
            cell.className = 'border p-2 text-center align-top';
            currentRow.appendChild(cell);
        }

        // Add days of month
        for (let day = 1; day <= lastDay.getDate(); day++) {
            if (currentRow.children.length === 7) {
                calendarBody.appendChild(currentRow);
                currentRow = document.createElement('tr');
                currentRow.className = 'h-24';
            }

            const cell = document.createElement('td');
            cell.className = 'border p-2 text-center align-top relative';
            
            const date = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);
            const dateString = date.toISOString().split('T')[0];
            
            // Check if this date has content
            const hasContent = dailyContent && 
                             dailyContent.daily_plans && 
                             Object.values(dailyContent.daily_plans).some(plan => plan.date === dateString);

            if (hasContent) {
                cell.classList.add('bg-indigo-50', 'hover:bg-indigo-100', 'cursor-pointer');
                cell.innerHTML = `
                    <div class="flex flex-col h-full">
                        <div class="text-lg font-medium">${day}</div>
                        <div class="text-xs text-indigo-600 mt-1">Daily Content</div>
                    </div>
                `;
                cell.onclick = () => showDayContent(date);
            } else {
                cell.innerHTML = `<div class="text-lg">${day}</div>`;
            }

            currentRow.appendChild(cell);
        }

        // Add empty cells for days after last of month
        while (currentRow.children.length < 7) {
            const cell = document.createElement('td');
            cell.className = 'border p-2 text-center align-top';
            currentRow.appendChild(cell);
        }

        // Append the last row
        if (currentRow.children.length > 0) {
            calendarBody.appendChild(currentRow);
        }
    }

    function showDayContent(date) {
        if (!dailyContent || !dailyContent.daily_plans) return;

        const dateStr = date.toISOString().split('T')[0];
        const plan = dailyContent.daily_plans[dateStr];
        
        if (!plan) {
            document.getElementById('day-content-container').innerHTML = 
                '<div class="text-gray-500">No content available for this date</div>';
            return;
        }

        try {
            const jsonStr = plan.content.split('```json\n')[1].split('\n```')[0];
            const planContent = JSON.parse(jsonStr);
            
            let contentHtml = `
                <div class="bg-white p-4 rounded-lg shadow mb-4">
                    <h3 class="text-lg font-semibold mb-2">Exam Information</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div><span class="font-medium">Exam Type:</span> ${dailyContent.exam_type}</div>
                        <div><span class="font-medium">Exam Date:</span> ${dailyContent.exam_date}</div>
                        <div><span class="font-medium">Days Until Exam:</span> ${dailyContent.days_until_exam}</div>
                    </div>
                </div>
                <div class="space-y-4">
            `;
            
            Object.entries(planContent).forEach(([day, dayData]) => {
                contentHtml += `
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h4 class="font-semibold text-lg mb-3">${day}</h4>
                        
                        <div class="mb-4">
                            <div class="font-medium text-sm text-gray-700 mb-2">Topics:</div>
                            <div class="flex flex-wrap gap-2">
                                ${dayData.topics.map(topic => 
                                    `<span class="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full">${topic}</span>`
                                ).join('')}
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="font-medium text-sm text-gray-700 mb-2">Time Allocation:</div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                ${Object.entries(dayData.time_allocation).map(([topic, hours]) => 
                                    `<div class="flex items-center">
                                        <div class="w-2 h-2 bg-indigo-400 rounded-full mr-2"></div>
                                        <span class="text-sm">${topic}: ${hours} hours</span>
                                    </div>`
                                ).join('')}
                            </div>
                        </div>

                        <div>
                            <div class="font-medium text-sm text-gray-700 mb-2">Key Concepts:</div>
                            <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                                ${dayData.key_concepts.map(concept => 
                                    `<li>${concept}</li>`
                                ).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            });
            
            contentHtml += '</div>';
            document.getElementById('day-content-container').innerHTML = contentHtml;
            
            // Update selected date display
            document.getElementById('selected-date').textContent = date.toLocaleDateString('default', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        } catch (e) {
            console.error('Error parsing plan content:', e);
            document.getElementById('day-content-container').innerHTML = `
                <div class="bg-red-50 border border-red-200 text-red-700 p-4 rounded">
                    Error parsing content for this date
                </div>
            `;
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        fetchDailyContent();
    });

    // Navigation handlers
    document.getElementById('prev-month').onclick = () => {
        currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1);
        updateCalendar();
    };

    document.getElementById('next-month').onclick = () => {
        currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1);
        updateCalendar();
    };
</script>
{% endblock %}
