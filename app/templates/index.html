{% extends "base.html" %}

{% block title %}Dashboard - Educational Content Analysis System{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Upload Section -->
    <div class="md:col-span-2 bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold mb-4">Upload Educational Content</h2>
        <div class="mb-6">
            <form id="upload-form" enctype="multipart/form-data">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Select Multiple Files (PDF or Images)</label>
                    <input type="file" id="file-input" name="files" multiple accept=".pdf,.jpg,.jpeg,.png,.webp"
                           class="w-full p-2 border border-gray-300 rounded">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Exam Type</label>
                    <select id="exam-type" name="exam_type" class="w-full p-2 border border-gray-300 rounded">
                        <option value="">-- Select Exam Type --</option>
                        <!-- Exam types will be populated dynamically -->
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Exam Date</label>
                    <input type="date" id="exam-date" name="exam_date" class="w-full p-2 border border-gray-300 rounded">
                </div>

                <div class="flex justify-between items-center">
                    <button type="submit" id="upload-button" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                        Upload and Process
                    </button>
                    <div id="upload-status" class="text-gray-600"></div>
                </div>
            </form>
        </div>

        <div id="results-container" class="hidden">
            <h3 class="text-xl font-bold mb-2">Processing Results</h3>
            <div id="results-content" class="border border-gray-200 rounded p-4 bg-gray-50 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Dashboard Summary -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold mb-4">Dashboard</h2>

        <div id="exam-info" class="mb-6 hidden">
            <h3 class="text-lg font-semibold mb-2" id="exam-name">Exam Name</h3>
            <p class="text-gray-600 mb-3" id="exam-description">Exam description will appear here.</p>

            <div class="grid grid-cols-2 gap-2 text-sm mb-4">
                <div>
                    <span class="text-gray-600">Preparation Time:</span>
                    <span class="font-semibold" id="exam-duration">6 months</span>
                </div>
                <div>
                    <span class="text-gray-600">Exam Date:</span>
                    <span class="font-semibold" id="selected-date">Not selected</span>
                </div>
                <div>
                    <span class="text-gray-600">Days Remaining:</span>
                    <span class="font-semibold" id="days-remaining">-</span>
                </div>
            </div>
        </div>

        <div id="no-exam-selected" class="mb-6">
            <div class="text-center py-2">
                <p class="text-gray-500">Select an exam type to see information</p>
            </div>
        </div>

        <div class="mb-6">
            <h3 class="text-lg font-semibold mb-2">Quick Stats</h3>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-blue-100 p-4 rounded-lg">
                    <div id="files-processed" class="text-3xl font-bold text-blue-700">0</div>
                    <div class="text-sm text-blue-700">Files Processed</div>
                </div>
                <div class="bg-green-100 p-4 rounded-lg">
                    <div id="tests-generated" class="text-3xl font-bold text-green-700">0</div>
                    <div class="text-sm text-green-700">Tests Generated</div>
                </div>
                <div class="bg-purple-100 p-4 rounded-lg">
                    <div id="questions-analyzed" class="text-3xl font-bold text-purple-700">0</div>
                    <div class="text-sm text-purple-700">Questions Analyzed</div>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg">
                    <div id="topics-identified" class="text-3xl font-bold text-yellow-700">0</div>
                    <div class="text-sm text-yellow-700">Topics Identified</div>
                </div>
            </div>
        </div>

        <div>
            <h3 class="text-lg font-semibold mb-2">Question Distribution</h3>
            <canvas id="question-chart" width="400" height="300"></canvas>
        </div>
    </div>
</div>

<!-- Motivational Quote -->
<div class="mt-6 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-lg shadow-md p-6 text-white">
    <div class="flex items-start">
        <div class="text-3xl mr-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
            </svg>
        </div>
        <div>
            <h3 class="text-xl font-bold mb-2">Today's Motivation</h3>
            <p id="motivational-quote" class="text-lg italic">"The harder you work for something, the greater you'll feel when you achieve it."</p>
        </div>
    </div>
</div>

<!-- Test Plans Section (will be shown after processing) -->
<div id="test-plans-section" class="mt-6 hidden">
    <h2 class="text-2xl font-bold mb-4">Generated Test Plans</h2>
    <div id="test-plans-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Test plans will be populated dynamically -->
    </div>
</div>

<!-- Note: Daily study plans are now shown in the Planner section -->

<!-- Recent Activity -->
<div class="mt-6 bg-white rounded-lg shadow-md p-6">
    <h2 class="text-2xl font-bold mb-4">Recent Activity</h2>
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white">
            <thead>
                <tr>
                    <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                        Date
                    </th>
                    <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                        Activity
                    </th>
                    <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                        Details
                    </th>
                    <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                        Status
                    </th>
                </tr>
            </thead>
            <tbody id="activity-table-body">
                <tr>
                    <td class="py-2 px-4 border-b border-gray-200" colspan="4">
                        No recent activity
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize question distribution chart
    const ctx = document.getElementById('question-chart').getContext('2d');
    const questionChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Objective', 'Subjective', 'Practical'],
            datasets: [{
                label: 'Question Distribution',
                data: [0, 0, 0],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(75, 192, 192, 0.6)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(75, 192, 192, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });

    // Fetch exam types on page load
    document.addEventListener('DOMContentLoaded', function() {
        fetchExamTypes();
        setDefaultExamDate();
        updateMotivationalQuote();

        // Add event listeners
        document.getElementById('exam-type').addEventListener('change', updateExamInfo);
        document.getElementById('exam-date').addEventListener('change', updateDaysRemaining);
        document.getElementById('upload-form').addEventListener('submit', uploadFiles);
    });

    // Fetch exam types from API
    async function fetchExamTypes() {
        try {
            const response = await fetch('/api/folder/exams');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const examTypes = await response.json();
            populateExamTypes(examTypes);
        } catch (error) {
            console.error('Error fetching exam types:', error);
        }
    }

    // Populate exam types dropdown
    function populateExamTypes(examTypes) {
        const examTypeSelect = document.getElementById('exam-type');

        examTypes.forEach(exam => {
            const option = document.createElement('option');
            option.value = exam.id;
            option.textContent = exam.name;
            option.dataset.description = exam.description;
            option.dataset.duration = exam.duration_months;
            examTypeSelect.appendChild(option);
        });
    }

    // Set default exam date (3 months from now)
    function setDefaultExamDate() {
        const examDateInput = document.getElementById('exam-date');
        const today = new Date();
        const threeMonthsLater = new Date(today);
        threeMonthsLater.setMonth(today.getMonth() + 3);

        const year = threeMonthsLater.getFullYear();
        const month = String(threeMonthsLater.getMonth() + 1).padStart(2, '0');
        const day = String(threeMonthsLater.getDate()).padStart(2, '0');

        examDateInput.value = `${year}-${month}-${day}`;
        updateDaysRemaining();
    }

    // Update exam information when exam type changes
    function updateExamInfo() {
        const examTypeSelect = document.getElementById('exam-type');
        const selectedOption = examTypeSelect.options[examTypeSelect.selectedIndex];

        const examInfo = document.getElementById('exam-info');
        const noExamSelected = document.getElementById('no-exam-selected');

        if (examTypeSelect.value) {
            // Show exam info
            examInfo.classList.remove('hidden');
            noExamSelected.classList.add('hidden');

            // Update exam details
            document.getElementById('exam-name').textContent = selectedOption.textContent;
            document.getElementById('exam-description').textContent = selectedOption.dataset.description;
            document.getElementById('exam-duration').textContent = `${selectedOption.dataset.duration} months`;

            updateDaysRemaining();
        } else {
            // Hide exam info
            examInfo.classList.add('hidden');
            noExamSelected.classList.remove('hidden');
        }
    }

    // Update days remaining until exam
    function updateDaysRemaining() {
        const examDateInput = document.getElementById('exam-date');
        const daysRemainingElement = document.getElementById('days-remaining');
        const selectedDateElement = document.getElementById('selected-date');

        if (examDateInput.value) {
            const examDate = new Date(examDateInput.value);
            const today = new Date();

            // Calculate days difference
            const diffTime = examDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            // Format date for display
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = examDate.toLocaleDateString(undefined, options);

            // Update elements
            selectedDateElement.textContent = formattedDate;

            if (diffDays < 0) {
                daysRemainingElement.textContent = 'Exam date is in the past';
                daysRemainingElement.classList.add('text-red-600');
            } else {
                daysRemainingElement.textContent = `${diffDays} days`;
                daysRemainingElement.classList.remove('text-red-600');
            }
        } else {
            selectedDateElement.textContent = 'Not selected';
            daysRemainingElement.textContent = '-';
        }
    }

    // Upload files
    async function uploadFiles(e) {
        e.preventDefault();

        const fileInput = document.getElementById('file-input');
        const examType = document.getElementById('exam-type').value;
        const examDate = document.getElementById('exam-date').value;

        if (fileInput.files.length === 0) {
            alert('Please select at least one file to upload.');
            return;
        }

        if (!examType) {
            alert('Please select an exam type.');
            return;
        }

        if (!examDate) {
            alert('Please select an exam date.');
            return;
        }

        // Show loading state
        const uploadButton = document.getElementById('upload-button');
        const uploadStatus = document.getElementById('upload-status');

        uploadButton.disabled = true;
        uploadButton.innerHTML = '<div class="loading"></div> Processing...';
        uploadStatus.textContent = `Uploading ${fileInput.files.length} file(s)...`;

        // Create form data
        const formData = new FormData();
        for (let i = 0; i < fileInput.files.length; i++) {
            formData.append('files', fileInput.files[i]);
        }
        formData.append('exam_type', examType);
        formData.append('exam_date', examDate);

        try {
            const response = await fetch('/api/folder/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            // Show results
            displayResults(data);

            // Update dashboard stats
            updateDashboardStats(data.result);

            // Update activity table
            updateActivityTable(data);

            // Reset form state
            uploadButton.disabled = false;
            uploadButton.textContent = 'Upload and Process';
            uploadStatus.textContent = `Successfully processed ${fileInput.files.length} file(s)`;

        } catch (error) {
            console.error('Error:', error);
            uploadButton.disabled = false;
            uploadButton.textContent = 'Upload and Process';
            uploadStatus.textContent = `Error: ${error.message}`;
        }
    }

    // Display processing results
    function displayResults(data) {
        const resultsContainer = document.getElementById('results-container');
        const resultsContent = document.getElementById('results-content');

        resultsContainer.classList.remove('hidden');

        if (data.status === 'success') {
            const result = data.result;

            let html = `
                <div class="mb-4">
                    <div class="text-green-600 font-semibold">${data.message}</div>
                    <div class="text-sm text-gray-600">Processed ${result.processed_files} files</div>
                </div>
            `;

            // Display test plans
            if (result.test_plans && result.test_plans.length > 0) {
                displayTestPlans(result.test_plans);
            }

            // Note: Daily content is now handled in the planner section

            // Update motivational quote
            if (result.motivational_quotes && result.motivational_quotes.length > 0) {
                const randomQuote = result.motivational_quotes[Math.floor(Math.random() * result.motivational_quotes.length)];
                document.getElementById('motivational-quote').textContent = `"${randomQuote}"`;
            }

            resultsContent.innerHTML = html;
        } else {
            resultsContent.innerHTML = `
                <div class="text-red-600 font-semibold">${data.message}</div>
                <div class="text-sm text-gray-600">${data.result ? JSON.stringify(data.result) : 'No details available'}</div>
            `;
        }
    }

    // Update dashboard stats
    function updateDashboardStats(result) {
        if (!result) return;

        // Update files processed
        document.getElementById('files-processed').textContent = result.processed_files || 0;

        // Update tests generated
        const testCount = result.test_plans ? result.test_plans.length : 0;
        document.getElementById('tests-generated').textContent = testCount;

        // Update questions analyzed (estimate based on test plans)
        let questionCount = 0;
        if (result.test_plans) {
            result.test_plans.forEach(plan => {
                if (plan.questions) {
                    questionCount += Array.isArray(plan.questions) ? plan.questions.length : 10;
                }
            });
        }
        document.getElementById('questions-analyzed').textContent = questionCount;

        // Update topics identified
        let topicsCount = 0;
        if (result.daily_content && result.daily_content.topics) {
            topicsCount = result.daily_content.topics.length;
        }
        document.getElementById('topics-identified').textContent = topicsCount || 5; // Default to 5 if not available

        // Update chart with distribution data
        if (result.test_plans && result.test_plans.length > 0) {
            const firstPlan = result.test_plans[0];
            if (firstPlan.distribution) {
                const distribution = firstPlan.distribution;
                updateChart([
                    distribution.objective?.marks || 30,
                    distribution.subjective?.marks || 40,
                    distribution.practical?.marks || 30
                ]);
            } else {
                // Default distribution if not available
                updateChart([30, 40, 30]);
            }
        } else {
            // Default distribution if no test plans
            updateChart([30, 40, 30]);
        }
    }

    // Display test plans
    function displayTestPlans(testPlans) {
        const testPlansSection = document.getElementById('test-plans-section');
        const testPlansContainer = document.getElementById('test-plans-container');

        testPlansSection.classList.remove('hidden');

        let html = '';

        testPlans.forEach((plan, index) => {
            html += `
                <div class="bg-white rounded-lg shadow-md p-4 hover-card">
                    <h3 class="text-lg font-semibold mb-2">${plan.title || `Test Plan ${index + 1}`}</h3>
                    <p class="text-gray-600 mb-3">${plan.description || 'Generated test plan'}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">${plan.questions ? `${Array.isArray(plan.questions) ? plan.questions.length : '10'} questions` : ''}</span>
                        <button class="text-indigo-600 hover:text-indigo-800 text-sm font-medium view-test-plan" data-index="${index}">
                            View Plan
                        </button>
                    </div>
                </div>
            `;
        });

        testPlansContainer.innerHTML = html;

        // Add event listeners to view buttons
        document.querySelectorAll('.view-test-plan').forEach(button => {
            button.addEventListener('click', function() {
                const index = this.getAttribute('data-index');
                alert(`Viewing test plan ${parseInt(index) + 1}... (This would show the full test plan in a real app)`);
            });
        });
    }

    // Note: Daily content display has been moved to the planner page

    // Update activity table
    function updateActivityTable(data) {
        const activityTableBody = document.getElementById('activity-table-body');

        if (!data || !data.result) {
            return;
        }

        const result = data.result;
        const date = new Date().toLocaleString();
        const statusClass = data.status === 'success' ? 'text-green-600' : 'text-red-600';

        let html = `
            <tr>
                <td class="py-2 px-4 border-b border-gray-200">${date}</td>
                <td class="py-2 px-4 border-b border-gray-200">Folder Processing</td>
                <td class="py-2 px-4 border-b border-gray-200">${result.processed_files} files for ${result.exam_type}</td>
                <td class="py-2 px-4 border-b border-gray-200 ${statusClass}">${data.status}</td>
            </tr>
        `;

        activityTableBody.innerHTML = html;
    }

    // Update chart
    function updateChart(data) {
        questionChart.data.datasets[0].data = data;
        questionChart.update();
    }

    // Update motivational quote
    function updateMotivationalQuote() {
        const quotes = [
            "The harder you work for something, the greater you'll feel when you achieve it.",
            "Success is the sum of small efforts, repeated day in and day out.",
            "Don't wish it were easier; wish you were better.",
            "The expert in anything was once a beginner.",
            "The only way to do great work is to love what you do.",
            "Believe you can and you're halfway there.",
            "It always seems impossible until it's done.",
            "Your time is limited, don't waste it living someone else's life.",
            "The future belongs to those who believe in the beauty of their dreams.",
            "The best way to predict the future is to create it."
        ];

        const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
        document.getElementById('motivational-quote').textContent = `"${randomQuote}"`;
    }
</script>
{% endblock %}
