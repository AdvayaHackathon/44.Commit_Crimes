{% extends "base.html" %}

{% block title %}Mock Test - e-Gurukool{% endblock %}

{% block head %}
<style>
    .test-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 1px solid rgba(99, 102, 241, 0.1);
        transition: all 0.3s ease;
    }

    .test-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .form-input {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 1px solid rgba(99, 102, 241, 0.2);
        transition: all 0.3s ease;
    }

    .form-input:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
    }

    .action-button {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        transition: all 0.3s ease;
    }

    .action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(99, 102, 241, 0.2);
    }

    .loading-spinner {
        border: 3px solid #f3f4f6;
        border-top: 3px solid #6366f1;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .dark .test-card {
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        border-color: rgba(99, 102, 241, 0.2);
    }

    .dark .form-input {
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        border-color: rgba(99, 102, 241, 0.2);
        color: #f3f4f6;
    }

    .question-card {
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 0.5s ease forwards;
    }

    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="test-card rounded-xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Generate Mock Test</h2>
        
        <form id="test-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-gray-700 dark:text-gray-300 mb-2">Subject</label>
                    <select id="subject" class="form-input w-full p-2 rounded-lg" required>
                        <option value="">Select Subject</option>
                        <option value="mathematics">Mathematics</option>
                        <option value="physics">Physics</option>
                        <option value="chemistry">Chemistry</option>
                        <option value="biology">Biology</option>
                        <option value="history">History</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-700 dark:text-gray-300 mb-2">Topic</label>
                    <input type="text" id="topic" class="form-input w-full p-2 rounded-lg" placeholder="e.g. Algebra, Mechanics, etc." required>
                </div>
                
                <div>
                    <label class="block text-gray-700 dark:text-gray-300 mb-2">Difficulty Level</label>
                    <select id="difficulty" class="form-input w-full p-2 rounded-lg" required>
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-700 dark:text-gray-300 mb-2">Number of Questions</label>
                    <input type="number" id="num-questions" class="form-input w-full p-2 rounded-lg" min="1" max="20" value="10" required>
                </div>
            </div>
            
            <div>
                <label class="block text-gray-700 dark:text-gray-300 mb-2">Additional Instructions (Optional)</label>
                <textarea id="instructions" class="form-input w-full p-2 rounded-lg" rows="3" placeholder="Any specific requirements or focus areas..."></textarea>
            </div>
            
            <div class="flex justify-end">
                <button type="submit" class="action-button text-white px-6 py-2 rounded-lg flex items-center space-x-2">
                    <span>Generate Test</span>
                    <div class="loading-spinner hidden"></div>
                </button>
            </div>
        </form>
    </div>
    
    <div id="test-content" class="space-y-6 hidden">
        <div class="test-card rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">Generated Test</h3>
                <div class="flex space-x-4">
                    <button id="print-test" class="action-button text-white px-4 py-2 rounded-lg">Print</button>
                    <button id="save-test" class="action-button text-white px-4 py-2 rounded-lg">Save</button>
                </div>
            </div>
            
            <div id="questions-container" class="space-y-6">
                <!-- Questions will be populated here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const testForm = document.getElementById('test-form');
    const testContent = document.getElementById('test-content');
    const questionsContainer = document.getElementById('questions-container');
    const loadingSpinner = document.querySelector('.loading-spinner');
    
    testForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Show loading state
        loadingSpinner.classList.remove('hidden');
        const submitButton = testForm.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        
        // Prepare the request data
        const requestData = {
            subject: document.getElementById('subject').value,
            topic: document.getElementById('topic').value,
            difficulty: document.getElementById('difficulty').value,
            numQuestions: parseInt(document.getElementById('num-questions').value),
            instructions: document.getElementById('instructions').value
        };
        
        try {
            // Make API call to generate test
            const response = await fetch('/api/mock-test/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                throw new Error('Failed to generate test');
            }
            
            const data = await response.json();
            
            // Display the generated test
            displayTest(data.questions);
            testContent.classList.remove('hidden');
            
            // Scroll to test content
            testContent.scrollIntoView({ behavior: 'smooth' });
            
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to generate test. Please try again.');
        } finally {
            // Reset loading state
            loadingSpinner.classList.add('hidden');
            submitButton.disabled = false;
        }
    });
    
    function displayTest(questions) {
        questionsContainer.innerHTML = '';
        
        questions.forEach((question, index) => {
            const questionCard = document.createElement('div');
            questionCard.className = 'question-card bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm';
            questionCard.style.animationDelay = `${index * 0.1}s`;
            
            questionCard.innerHTML = `
                <div class="flex items-start">
                    <span class="text-indigo-600 dark:text-indigo-400 font-bold mr-4">${index + 1}.</span>
                    <div class="flex-1">
                        <p class="text-gray-800 dark:text-gray-200 mb-4">${question.text}</p>
                        ${question.type === 'mcq' ? renderMCQ(question.options) : ''}
                        ${question.type === 'subjective' ? '<textarea class="form-input w-full p-2 rounded-lg mt-2" rows="3" placeholder="Enter your answer..."></textarea>' : ''}
                    </div>
                </div>
            `;
            
            questionsContainer.appendChild(questionCard);
        });
    }
    
    function renderMCQ(options) {
        return `
            <div class="space-y-2 mt-2">
                ${options.map((option, idx) => `
                    <div class="flex items-center space-x-3">
                        <input type="radio" id="option-${idx}" name="mcq" class="text-indigo-600 focus:ring-indigo-500">
                        <label for="option-${idx}" class="text-gray-700 dark:text-gray-300">${option}</label>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    // Print functionality
    document.getElementById('print-test').addEventListener('click', function() {
        window.print();
    });
    
    // Save functionality
    document.getElementById('save-test').addEventListener('click', async function() {
        try {
            const response = await fetch('/api/mock-test/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    test: {
                        subject: document.getElementById('subject').value,
                        topic: document.getElementById('topic').value,
                        questions: Array.from(questionsContainer.children).map(card => ({
                            text: card.querySelector('p').textContent,
                            type: card.querySelector('textarea') ? 'subjective' : 'mcq',
                            options: card.querySelector('.space-y-2') ? 
                                Array.from(card.querySelectorAll('label')).map(label => label.textContent) : 
                                undefined
                        }))
                    }
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to save test');
            }
            
            alert('Test saved successfully!');
            
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to save test. Please try again.');
        }
    });
});
</script>
{% endblock %} 